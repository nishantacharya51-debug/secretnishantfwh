<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Smart Calling</title>
  <style>
    :root{
      --bg1:#1b1b1b;
      --bg2:#cfcfcf;
      --card:#1b2bd6;
      --white:#ffffff;
      --muted:#d1d5db;
      --text:#111827;
      --shadow: 0 18px 55px rgba(0,0,0,.45);
      --radius:22px;
      --neon:#c7ff3c;
      --pill:#2f2f2f;
      --btnRed:#d61c1c;
      --btnRed2:#b31212;
      --btnBlue:#2563eb;
      --btnBlue2:#1d4ed8;
      --border: rgba(255,255,255,.18);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:center;
      overflow:hidden;
      background: linear-gradient(90deg, #2a2a2a 0%, #8f8f8f 55%, #e5e5e5 100%);
    }

    /* ---------- SHARED ---------- */
    .hidden{display:none !important}
    .wrap{
      width:min(1250px, 100%);
      padding:18px;
    }
    .topBrand{
      position:absolute;
      top:18px;
      left:18px;
      display:flex;
      align-items:center;
      gap:10px;
      color:#0b0b0b;
      opacity:.85;
      font-weight:700;
    }
    .logo{
      width:34px;height:34px;border-radius:999px;
      background: conic-gradient(from 0deg, #111 0 30%, #444 30% 60%, #111 60% 100%);
      box-shadow:0 8px 18px rgba(0,0,0,.25);
    }

    /* ---------- PAGE 1 (WELCOME LOGIN) ---------- */
    #pageLogin{
      position:relative;
      width:100%;
      min-height: calc(100vh - 36px);
      border-radius: 26px;
      overflow:hidden;
    }

    /* Decorative faces (CSS-only placeholders to match your style) */
    .face{
      position:absolute;
      filter: grayscale(1);
      opacity:.35;
      border: 4px solid rgba(199,255,60,.55);
      border-radius: 28px;
      box-shadow: 0 16px 40px rgba(0,0,0,.35);
      background:
        radial-gradient(circle at 35% 35%, rgba(255,255,255,.55), transparent 55%),
        radial-gradient(circle at 60% 30%, rgba(255,255,255,.35), transparent 60%),
        radial-gradient(circle at 50% 70%, rgba(0,0,0,.35), transparent 60%),
        linear-gradient(135deg, rgba(0,0,0,.65), rgba(255,255,255,.35));
    }
    .face.leftBig{left:-140px; top:110px; width:380px; height:380px; transform:rotate(-18deg)}
    .face.rightBig{right:-140px; top:110px; width:380px; height:380px; transform:rotate(18deg); opacity:.22}
    .face.bottomLeft{left:140px; bottom:-120px; width:260px; height:260px; opacity:.55}
    .face.bottomRight{right:140px; bottom:-120px; width:260px; height:260px; opacity:.55}

    .welcomeText{
      position:absolute;
      top:55px;
      width:100%;
      text-align:center;
      font-size:76px;
      font-weight:900;
      letter-spacing:2px;
      color:#ff7a1a;
      text-shadow:
        0 6px 0 rgba(0,0,0,.35),
        0 14px 30px rgba(0,0,0,.25);
      transform: skewX(-8deg);
    }

    .loginCard{
      position:absolute;
      left:50%;
      top:52%;
      transform:translate(-50%,-50%);
      width:min(520px, 92%);
      background: rgba(16, 20, 140, .98);
      border-radius: 26px;
      box-shadow: var(--shadow);
      padding: 26px 22px 20px;
    }

    .loginInputs{
      display:grid;
      grid-template-columns: 54px 1fr;
      gap:14px 14px;
      align-items:center;
      margin-top: 8px;
    }

    .iconBox{
      width:54px;height:54px;border-radius:14px;
      background: rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.18);
      display:flex;align-items:center;justify-content:center;
      font-size:22px;
      color:#fff;
      user-select:none;
    }
    .in{
      width:100%;
      padding:14px 14px;
      border-radius: 18px;
      border: 0;
      outline:none;
      background: rgba(220, 245, 255, 1);
      font-size:18px;
      color:#0b1220;
    }

    .joinBtn{
      margin-top:16px;
      width:190px;
      height:54px;
      border-radius: 999px;
      border:0;
      cursor:pointer;
      font-weight:900;
      font-size:22px;
      letter-spacing:1px;
      color:white;
      background: radial-gradient(circle at 30% 25%, #ff4a4a, #c80000);
      box-shadow: 0 12px 26px rgba(0,0,0,.35);
    }
    .joinBtn:hover{filter:brightness(1.05)}
    .powered{
      margin-top:10px;
      text-align:center;
      color: rgba(255,255,255,.75);
      font-size:12px;
      letter-spacing:.2px;
    }

    .statusLine{
      margin-top:10px;
      text-align:center;
      color: rgba(255,255,255,.92);
      font-size:13px;
    }

    .miniInfo{
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      bottom:18px;
      background: rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.22);
      color:#fff;
      padding:8px 12px;
      border-radius: 999px;
      font-size:12px;
      backdrop-filter: blur(8px);
    }

    /* ---------- PAGE 2 (CALL UI LIKE YOUR IMAGE) ---------- */
    #pageCall{
      width:100%;
      min-height: calc(100vh - 36px);
      border-radius: 26px;
      overflow:hidden;
      position:relative;
      background: linear-gradient(180deg, #ffffff 0%, #f3f4f6 100%);
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 24px;
    }

    .projectorBar{
      position:absolute;
      top:18px;
      width:min(1100px, 96%);
      height:34px;
      background: linear-gradient(180deg, #d0d0d0, #b5b5b5);
      border-radius: 22px;
      border:1px solid rgba(0,0,0,.15);
      box-shadow: 0 10px 20px rgba(0,0,0,.12);
    }

    .screens{
      width:min(1100px, 96%);
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:18px;
      margin-top: 32px;
    }
    @media (max-width: 920px){
      .screens{grid-template-columns:1fr}
    }

    .screen{
      position:relative;
      height: 390px;
      border: 8px solid #0b0b0b;
      border-radius: 10px;
      background:#fff;
      box-shadow: 0 22px 48px rgba(0,0,0,.18);
      overflow:hidden;
    }
    video{
      width:100%;
      height:100%;
      object-fit:cover;
      background:#000;
      display:block;
    }
    .pullCord{
      position:absolute;
      bottom:-46px;
      left:50%;
      transform:translateX(-50%);
      width:6px;
      height:48px;
      background:#0b0b0b;
      border-radius: 8px;
    }
    .pullCord::after{
      content:"";
      position:absolute;
      bottom:-10px;
      left:50%;
      transform:translateX(-50%);
      width:18px;height:18px;border-radius:999px;
      background:#0b0b0b;
    }
    .tag{
      position:absolute;
      left:14px;
      bottom:14px;
      background: rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.25);
      color:#fff;
      padding:7px 10px;
      border-radius:999px;
      font-size:12px;
      backdrop-filter: blur(6px);
    }

    .pillControls{
      position:absolute;
      bottom:24px;
      width:min(1100px, 96%);
      background: rgba(25,25,25,.88);
      border-radius: 999px;
      padding: 18px 18px;
      display:flex;
      justify-content:space-around;
      gap:14px;
      align-items:center;
      box-shadow: 0 22px 55px rgba(0,0,0,.25);
    }
    .pillItem{
      color:#fff;
      text-align:center;
      font-weight:700;
      letter-spacing:.2px;
      min-width: 150px;
    }
    .pillItem .label{font-size:30px; line-height:1}
    .pillItem .txt{font-size:28px; margin-bottom:10px}
    .pillItem small{display:block;color:#d1d5db;font-weight:600;margin-top:2px}

    .btnRound{
      width:58px;height:58px;border-radius:999px;
      border:1px solid rgba(255,255,255,.22);
      background: rgba(255,255,255,.10);
      display:flex;align-items:center;justify-content:center;
      cursor:pointer;
      user-select:none;
      font-size:22px;
    }
    .btnRound:hover{background: rgba(255,255,255,.18)}
    .btnRound.red{
      background: rgba(220,38,38,.95);
      border:1px solid rgba(255,255,255,.25);
    }
    .btnRound.red:hover{background: rgba(185,28,28,.98)}

    /* small debug toast */
    .toast{
      position:absolute;
      top:18px;
      right:18px;
      background: rgba(0,0,0,.62);
      border:1px solid rgba(255,255,255,.22);
      color:#fff;
      padding:10px 12px;
      border-radius: 14px;
      font-size:12px;
      max-width: 420px;
      backdrop-filter: blur(10px);
      white-space:pre-wrap;
    }
  </style>
</head>
<body>
  <div class="topBrand">
    <div class="logo"></div>
    <div>Smart Calling</div>
  </div>

  <div class="wrap">
    <!-- PAGE 1 -->
    <div id="pageLogin">
      <div class="face leftBig"></div>
      <div class="face rightBig"></div>
      <div class="face bottomLeft"></div>
      <div class="face bottomRight"></div>

      <div class="welcomeText">WELCOME</div>

      <div class="loginCard">
        <div class="loginInputs">
          <div class="iconBox">üë§</div>
          <input class="in" id="username" placeholder="Username (any)" autocomplete="off"/>

          <div class="iconBox">üîí</div>
          <input class="in" id="password" type="password" placeholder="Password" autocomplete="off"/>
        </div>

        <div style="display:flex;justify-content:center;">
          <button class="joinBtn" id="joinBtn">JOIN</button>
        </div>

        <div class="powered">Power by Nishant Acharya</div>
        <div class="statusLine" id="loginStatus">Status: Locked</div>
      </div>

      <div class="miniInfo">Fixed Room ID: <b>111234</b> ‚Ä¢ Password: <b>Nishant@123</b></div>
    </div>

    <!-- PAGE 2 -->
    <div id="pageCall" class="hidden">
      <div class="projectorBar"></div>

      <div class="screens">
        <div class="screen">
          <video id="localVideo" autoplay playsinline muted></video>
          <div class="tag">You</div>
          <div class="pullCord"></div>
        </div>

        <div class="screen">
          <video id="remoteVideo" autoplay playsinline></video>
          <div class="tag">Other</div>
          <div class="pullCord"></div>
        </div>
      </div>

      <div class="pillControls">
        <div class="pillItem">
          <div class="txt">Window closed</div>
          <button class="btnRound" id="winCloseBtn" title="Hide remote video">ü™ü</button>
          <small>toggle</small>
        </div>

        <div class="pillItem">
          <div class="txt">Window open</div>
          <button class="btnRound" id="winOpenBtn" title="Show remote video">ü™ü</button>
          <small>toggle</small>
        </div>

        <div class="pillItem">
          <div class="txt">Screen Share</div>
          <button class="btnRound" id="shareBtn" title="Share screen">üñ•Ô∏è</button>
          <small>replace video</small>
        </div>

        <div class="pillItem">
          <div class="txt">Apply Effect</div>
          <button class="btnRound" id="effectBtn" title="Simple blur effect (local only)">‚ú®</button>
          <small>demo only</small>
        </div>

        <div class="pillItem">
          <div class="txt">End</div>
          <button class="btnRound red" id="hangBtn" title="Leave call">üìû</button>
          <small>leave</small>
        </div>
      </div>

      <div class="toast" id="toast">Connecting‚Ä¶</div>
    </div>
  </div>

  <!-- Firebase Modular v9 (NO compat mixing) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import {
      getDatabase, ref, get, set, remove,
      onValue, onChildAdded, off, push, child
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    // ========= FIXED ROOM + PASSWORD =========
    const FIXED_ROOM_ID = "111234";
    const FIXED_PASSWORD = "Nishant@123";

    // ========= YOU MUST PASTE YOUR REAL FIREBASE CONFIG =========
    // Firebase Console ‚Üí Project settings ‚Üí Your apps ‚Üí Web app config
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT-default-rtdb.firebaseio.com",
      projectId: "YOUR_PROJECT",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    // ========= UI =========
    const pageLogin = document.getElementById("pageLogin");
    const pageCall  = document.getElementById("pageCall");
    const loginStatus = document.getElementById("loginStatus");
    const toast = document.getElementById("toast");

    const usernameEl = document.getElementById("username");
    const passwordEl = document.getElementById("password");
    const joinBtn = document.getElementById("joinBtn");

    const localVideo = document.getElementById("localVideo");
    const remoteVideo = document.getElementById("remoteVideo");

    const winCloseBtn = document.getElementById("winCloseBtn");
    const winOpenBtn = document.getElementById("winOpenBtn");
    const shareBtn = document.getElementById("shareBtn");
    const effectBtn = document.getElementById("effectBtn");
    const hangBtn = document.getElementById("hangBtn");

    const setToast = (t) => toast.textContent = t;

    // ========= FIREBASE INIT =========
    let db;
    try{
      const app = initializeApp(firebaseConfig);
      db = getDatabase(app);
    }catch(e){
      alert("Firebase config is wrong. Paste your REAL firebaseConfig.");
      throw e;
    }

    // ========= WEBRTC =========
    const rtcConfig = {
      iceServers: [
        { urls: "stun:stun.l.google.com:19302" }
        // NOTE: For mobile data / different networks, TURN may be required.
      ]
    };

    let pc = null;
    let localStream = null;
    let remoteStream = null;
    let isCaller = false;

    const roomId = FIXED_ROOM_ID;
    const roomRef = ref(db, `rooms/${roomId}`);

    async function startMedia(){
      if (localStream) return;
      localStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
      localVideo.srcObject = localStream;
      await localVideo.play().catch(()=>{});
    }

    function makePeer(){
      pc = new RTCPeerConnection(rtcConfig);

      remoteStream = new MediaStream();
      remoteVideo.srcObject = remoteStream;

      localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

      pc.ontrack = (e) => {
        e.streams[0].getTracks().forEach(t => remoteStream.addTrack(t));
      };

      pc.onicecandidate = (e) => {
        if (!e.candidate) return;
        const path = isCaller ? "callerCandidates" : "calleeCandidates";
        push(ref(db, `rooms/${roomId}/${path}`), e.candidate.toJSON());
      };
    }

    async function createOrJoinRoom(){
      setToast("Starting camera‚Ä¶");
      await startMedia();
      makePeer();

      // Clear old listeners to avoid duplicates
      off(roomRef);

      setToast("Checking room‚Ä¶");
      const snap = await get(roomRef);
      const data = snap.exists() ? snap.val() : null;

      if (!data || !data.offer){
        // CALLER
        isCaller = true;
        setToast("Caller: creating offer‚Ä¶");

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);

        await set(roomRef, {
          offer: { type: offer.type, sdp: offer.sdp },
          createdAt: Date.now()
        });

        // Listen answer
        onValue(child(roomRef, "answer"), async (s) => {
          const ans = s.val();
          if (!ans) return;
          if (!pc.currentRemoteDescription){
            await pc.setRemoteDescription(ans);
            setToast("Connected ‚úÖ (answer received)");
          }
        });

        // Listen callee ICE
        onChildAdded(child(roomRef, "calleeCandidates"), (s) => {
          const c = s.val();
          if (c) pc.addIceCandidate(c).catch(()=>{});
        });

      } else {
        // CALLEE
        isCaller = false;
        setToast("Callee: answering‚Ä¶");

        await pc.setRemoteDescription(data.offer);
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);

        await set(child(roomRef, "answer"), { type: answer.type, sdp: answer.sdp });

        // Listen caller ICE
        onChildAdded(child(roomRef, "callerCandidates"), (s) => {
          const c = s.val();
          if (c) pc.addIceCandidate(c).catch(()=>{});
        });

        setToast("Connected ‚úÖ (answered)");
      }
    }

    async function leaveCall(clearRoom=false){
      setToast("Leaving‚Ä¶");

      try{ off(roomRef); }catch{}
      try{ pc?.close(); }catch{}
      pc = null;

      try{ localStream?.getTracks().forEach(t => t.stop()); }catch{}
      localStream = null;

      remoteStream = null;
      localVideo.srcObject = null;
      remoteVideo.srcObject = null;

      if (clearRoom){
        try{ await remove(roomRef); }catch{}
      }

      // Back to login page
      pageCall.classList.add("hidden");
      pageLogin.classList.remove("hidden");
      loginStatus.textContent = "Status: Locked";
      setToast("Disconnected.");
    }

    // ========= LOGIN BUTTON =========
    joinBtn.onclick = async () => {
      const pass = passwordEl.value.trim();
      if (pass !== FIXED_PASSWORD){
        loginStatus.textContent = "Status: Wrong password ‚ùå";
        return alert("Wrong password!");
      }
      if (!usernameEl.value.trim()){
        usernameEl.value = "Guest";
      }

      loginStatus.textContent = "Status: Correct ‚úÖ Connecting‚Ä¶";

      // Switch to call UI
      pageLogin.classList.add("hidden");
      pageCall.classList.remove("hidden");
      setToast("Connecting to room 111234‚Ä¶");

      try{
        await createOrJoinRoom();
      }catch(e){
        console.error(e);
        alert(
          "Connection error:\n" + e.message +
          "\n\nCHECK THESE:\n" +
          "1) Firebase config is real\n" +
          "2) Realtime Database enabled\n" +
          "3) Rules allow read/write (testing)\n" +
          "4) Page is HTTPS\n"
        );
        await leaveCall(false);
      }
    };

    // ========= BOTTOM CONTROLS =========
    winCloseBtn.onclick = () => {
      // hide remote video (demo window closed)
      remoteVideo.style.opacity = "0";
      setToast("Window closed (remote hidden)");
    };

    winOpenBtn.onclick = () => {
      remoteVideo.style.opacity = "1";
      setToast("Window open (remote visible)");
    };

    effectBtn.onclick = () => {
      // simple local blur demo
      const current = localVideo.style.filter;
      localVideo.style.filter = current.includes("blur") ? "none" : "blur(6px)";
      setToast("Effect toggled (local preview)");
    };

    shareBtn.onclick = async () => {
      try{
        if (!pc) return alert("Not connected yet.");
        const screenStream = await navigator.mediaDevices.getDisplayMedia({ video:true, audio:false });
        const screenTrack = screenStream.getVideoTracks()[0];

        const sender = pc.getSenders().find(s => s.track && s.track.kind === "video");
        if (sender) await sender.replaceTrack(screenTrack);

        setToast("Screen share started ‚úÖ");

        screenTrack.onended = async () => {
          // revert to camera
          const camTrack = localStream?.getVideoTracks()[0];
          if (sender && camTrack) await sender.replaceTrack(camTrack);
          setToast("Screen share ended.");
        };
      }catch(e){
        alert("Screen share failed: " + e.message);
      }
    };

    hangBtn.onclick = async () => {
      // IMPORTANT: do NOT remove room automatically or the other user may drop.
      await leaveCall(false);
    };

    // ========= IMPORTANT NOTE (ROOM STUCK) =========
    // If room gets stuck (old offer remains), you can manually clear it by opening DevTools and run:
    // remove(ref(db, `rooms/${roomId}`))
    // Or you can modify hangBtn to leaveCall(true) if you want always clear (not recommended).
  </script>
</body>
</html>
